# MNase-Seq - Watzlowik et al

This directory contains code to reproduce the MNase-Seq analysis for the Plasmodium Snf2L Paper.
It contains the pipeline used to map the raw sequencing reads, filter for mononucleosomes and call nucleosomes. Addionally a small test dataset to test the pipeline is included. Furthermore there is example code for the analysis and plotting of the results.

The pipeline is based on [bowtie2](https://bowtie-bio.sourceforge.net/bowtie2/index.shtml) for mapping, [deeptools](https://deeptools.readthedocs.io/en/latest/) for filtering and [danpos3](https://github.com/sklasfeld/DANPOS3) for nucleosome calling and differential nucleosome positioning. A custom script is used to adjust DANPOS3 results (`AdjustFDR`, for more information see below).

The [nucleosome dynamics](https://github.com/nucleosome-dynamics/nucleosome_dynamics) package was used to find NDRs. Unfortunatelly the docker container provided by the authors did not work in our hands and had to be adjusted. All files required to build and run the edited docker are also provided in the `1_code` section.

## Pipeline

### Requirements

This code has been tested on macOS 13.4.1 but should run on any UNIX system.

It requires the following software:

  - conda (tested with v23.1.0)
  - samtools (tested with v1.12)
  - snakemake (tested with v7.26.0)
    - snakemake will install:
      - deeptools v3.5.0
      - multiqc v1.11
      - qualimap v2.2.2
      - samtools v1.12
      - bowtie2 v2.3.5
      - skewer v0.2.2
      - sra-tools v2.9.6
      - danpos v3.1

Most of the dependencies will be automaticly installed via conda(see [Installation](#Installation)).

### Installation

Download the repository and install [conda](https://conda.io/projects/conda/en/stable/user-guide/install/index.html). Conda will handle installation of most additional packages.

Addionally DANPOS3 will be downloaded by `preperation.sh` because it is currently not available via conda.

### Usage

Run the following commands to create a new environment with the required software.

```shell
conda create -n watzlowik_2023_MNase -c bioconda snakemake=7.26.0 samtools=1.12
```

Then activate the environment and make sure you are located in the RNA-Seq directory.
Now run the `preperation.sh` script to download reference genome and annotation and the [DANPOS3](https://github.com/sklasfeld/DANPOS3) program (which is not available via conda).

```shell
conda activate watzlowik_2023_MNase
cd <PATH TO MNase-Seq DIR>
./preperation.sh
```

Finally adjust the `config.yaml` to your needs or just start the pipeline with the test-data provided.

```shell
snakemake --use-conda
```

To deactivate the conda environment run:

```shell
conda deactivate
```

### Expected Results

The snakemake pipeline creates an addional directory called `2_pipeline/` which contains logs for the individual steps (`00_logs`), quality control which is conveniently summarised as a multiqc report (`00_qc/mapping/multiqc/` and `00_qc/filtered/multiqc/`), intermediate trimmed fastq files (`01_trimmed_reads`) and resulting alignments and filtered alignments (`02_alignment`, `03_alignment_filtered`) in `.bam` format. Nucleosome Positions can be found in the `04_differential_nucleosome_positioning` directory with the main adjusted results at `04_differential_nucleosome_positioning/results/adjustedFDR/`.

## AdjustFDR

The way danpos calculates FDR values is possibly not correct. Therefore we wrote `AdjustFDR.R`, an R-script for correct determination of FDRs for nucleosome dynamics statistics. It simulates additional, random nucleosomes, calculates their pvalue and uses those simulated values for correct FDR estimation. More information can be found in the dedicated README

the script is written in R and uses the following addition libraries:

 - plyranges v1.10
 - fs v1.5.0
 - argparser v0.7.1
 - tidyverse v1.3.0

## Nucleosome Dynamics

`1_code/nucleosomeDynamics/` include the code used to run the [nucleosome dynamics](https://github.com/nucleosome-dynamics/nucleosome_dynamics) package. The docker container was edited as we were not able to run the original.

### Requirements

Naturally building and running the nucleosome dynamics docker container requires [docker](https://www.docker.com/get-started/). All other dependencies are automaticly installed except for the annotation gff-file.

Nucleosome Dynamics requires a special gff with tss and tts included. This gff file is generated by `get_nucleosomeDynamics_gff.R`. This script requires R, tidyverse and plyranges.

To build the docker image run inside the unzipped docker directory:

```shell
docker build -t nucleosomedynamics_docker_edited .
```

To run the analysis first edit `runNucDyn_merged.sh` and include an absolute `project_path` which is required for docker. Then run the script:

```shell
./runNucDyn_merged.sh
```

## Additional Code

Additional code is provided in `0_code/`.

`find_dynamic_nucleosomes.R` is the script used to find dynamic nucleosomes. Dynamic nucleosomes are defined as nucleosomes with the highest variance in occupancy, fuzziness and position. The cutoff is defined by slope = 1 of a curve of their normalized dynamics parameter from DANPOS vs their normalized rank.

`mnase_plots.Rmd` contains code to recreate the plots in the manuscript. However execution is limited with the provided test data. Although the scripts have been edited and documented to the best of our knowledge and belief the scripts have to be seen just as guidance and might not work immediately as is. Paths may require adjustments but the specific commands are the ones used in our analysis.

### Requirements

Analysis was performed using R v4.2.2.
Additional libraries used are:

  - tidyverse v2.0.0
  - plyranges v1.18.0
  - ggpubr v0.6.0
  - rtracklayer v1.58.0
  - GenomicRanges v1.50.2
  - ggridges v0.5.4
